<!-- /snippets/discount-coupon.liquid -->

{%- liquid
  assign variant_id = variant_id | default: block.settings.variant_id | default: ''
  assign discount_type = discount_type | default: block.settings.discount_type | default: 'percentage'
  assign discount_value = discount_value | default: block.settings.discount_value | default: 0
  assign discount_code = discount_code | default: block.settings.discount_code | default: ''
  assign final_price_info = final_price_info | default: block.settings.final_price_info | default: ''
  assign code_info_template = code_info_template | default: block.settings.code_info_template | default: 'Code: {discount_code}'
-%}

{%- if discount_code != '' -%}
  <discount-coupon
    data-variant-id="{{ variant_id }}"
    {% if block %}{{ block.shopify_attributes }}{% endif %}
    style="padding-bottom: {{ block.settings.padding_bottom | default: 10 }}px;"
  >
    <div class="discount-coupon">
    <div
      class="discount-coupon-content"
      data-type="{{ discount_type }}"
      data-value="{{ discount_value }}"
      data-code="{{ discount_code }}"
      data-final-price-info="{{ final_price_info }}"
      data-code-info="{{ code_info_template }}"
    >
      <div class="discount-coupon-info">
        <div class="discount-coupon-info-title">
          {%- if discount_type == 'percentage' -%}
            {{ discount_value }}% OFF
          {%- else -%}
            {%- liquid
              assign discount_amount = discount_value | times: 1.0
              assign discount_cents = discount_amount | times: 100 | round
            -%}
            {{ discount_cents | money }} OFF
          {%- endif -%}
        </div>
        {%- if final_price_info != '' -%}
          <div class="discount-coupon-info-desc">{{ final_price_info }}</div>
        {%- endif -%}
      </div>
      <div class="discount-coupon-code">
        <div class="discount-coupon-code-text">
          {%- liquid
            assign code_display = code_info_template
            assign placeholder = '{discount_code}'
            if code_display contains placeholder
              assign code_display = code_display | replace: placeholder, discount_code
            endif
          -%}
          {{ code_display }}
        </div>
        <button
          type="button"
          class="discount-coupon-code-btn"
          data-copy-coupon-btn
          aria-label="{{ 'general.share.copy_to_clipboard' | t }}"
        >
          <span class="discount-coupon-code-btn-before">Copy</span>
          <span class="discount-coupon-code-btn-after">Copied!</span>
        </button>
      </div>
    </div>
    </div>
  </discount-coupon>

  <style>
    discount-coupon {
      display: none
    }

    discount-coupon.dl-show {
      display: block
    }

    .discount-coupon {
      height: 88px
    }

    .discount-coupon-content {
      display: flex;
      height: 100%;
    }

    .discount-coupon-info {
      position: relative
    }

    .discount-coupon-info {
      background-color: #315800
    }

    .discount-coupon-info {
      color: white
    }

    .discount-coupon-info {
      height: 100%
    }

    .discount-coupon-info {
      padding: 0 32px 0 34px
    }

    .discount-coupon-info {
      display: flex
    }

    .discount-coupon-info {
      flex-direction: column
    }

    .discount-coupon-info {
      justify-content: center
    }

    .discount-coupon-info {
      width: fit-content
    }

    .discount-coupon-info {
      border-right: 2px white dashed
    }

    .discount-coupon-info::before,
    .discount-coupon-info::after,
    .discount-coupon-code::before,
    .discount-coupon-code::after {
      content: ""
    }

    .discount-coupon-info::before,
    .discount-coupon-info::after,
    .discount-coupon-code::before,
    .discount-coupon-code::after {
      width: 20px
    }

    .discount-coupon-info::before,
    .discount-coupon-info::after,
    .discount-coupon-code::before,
    .discount-coupon-code::after {
      height: 20px
    }

    .discount-coupon-info::before,
    .discount-coupon-info::after,
    .discount-coupon-code::before,
    .discount-coupon-code::after {
      border-radius: 100%
    }

    .discount-coupon-info::before,
    .discount-coupon-info::after,
    .discount-coupon-code::before,
    .discount-coupon-code::after {
      background-color: white
    }

    .discount-coupon-info::before,
    .discount-coupon-info::after,
    .discount-coupon-code::before,
    .discount-coupon-code::after {
      position: absolute
    }

    .discount-coupon-info::before,
    .discount-coupon-info::after,
    .discount-coupon-code::before,
    .discount-coupon-code::after {
      left: 0
    }

    .discount-coupon-info::before,
    .discount-coupon-code::before {
      top: 0
    }

    .discount-coupon-info::before,
    .discount-coupon-code::before {
      transform: translate(-50%, -50%)
    }

    .discount-coupon-info::after,
    .discount-coupon-code::after {
      bottom: 0
    }

    .discount-coupon-info::after,
    .discount-coupon-code::after {
      transform: translate(-50%, 50%)
    }

    .discount-coupon-info-title {
      font-size: 24px
    }

    .discount-coupon-info-title {
      font-style: normal
    }

    .discount-coupon-info-title {
      font-weight: 500
    }

    .discount-coupon-info-title {
      line-height: normal
    }

    .discount-coupon-info-title {
      white-space: nowrap
    }

    .discount-coupon-info-desc {
      font-size: 16px
    }

    .discount-coupon-info-desc {
      font-style: normal
    }

    .discount-coupon-info-desc {
      font-weight: 400
    }

    .discount-coupon-info-desc {
      line-height: 150%
    }

    .discount-coupon-info-desc {
      white-space: nowrap
    }

    .discount-coupon-code {
      display: flex
    }

    .discount-coupon-code {
      flex-grow: 1
    }

    .discount-coupon-code {
      position: relative
    }

    .discount-coupon-code {
      align-items: center
    }

    .discount-coupon-code {
      padding: 0 24px
    }

    .discount-coupon-code {
      background-color: #eaeee5
    }

    .discount-coupon-code {
      justify-content: space-between
    }

    .discount-coupon-code {
      gap: 8px
    }

    .discount-coupon-code {
      border-radius: 4px
    }

    .discount-coupon-code-btn-after {
      display: none
    }

    .discount-coupon-code-btn.dl-copied .discount-coupon-code-btn-after {
      display: block
    }

    .discount-coupon-code-btn.dl-copied .discount-coupon-code-btn-before {
      display: none
    }

    .discount-coupon-code-btn {
      border-radius: 50px
    }

    .discount-coupon-code-btn {
      border: 2px solid #315800
    }

    .discount-coupon-code-btn {
      color: #315800
    }

    .discount-coupon-code-btn {
      display: flex
    }

    .discount-coupon-code-btn {
      align-items: center
    }

    .discount-coupon-code-btn {
      justify-content: center
    }

    .discount-coupon-code-btn {
      padding: 0 16px
    }

    .discount-coupon-code-btn {
      height: 40px
    }

    .discount-coupon-code-btn {
      background: transparent
    }

    .discount-coupon-code-btn {
      cursor: pointer
    }

    .discount-coupon-code-btn span {
      font-size: 16px
    }

    .discount-coupon-code-btn span {
      font-style: normal
    }

    .discount-coupon-code-btn span {
      font-weight: 400
    }

    .discount-coupon-code-btn span {
      line-height: 140%
    }

    .discount-coupon-code-text {
      font-size: 16px
    }

    .discount-coupon-code-text {
      font-style: normal
    }

    .discount-coupon-code-text {
      font-weight: 400
    }

    .discount-coupon-code-text {
      color: #315800
    }

    @media screen and (min-width: 991px) and (max-width: 1440px) {
        .discount-coupon {
            height: 6.11vw;
        }
    }

    @media screen and (max-width: 990px) {
      .discount-coupon {
        height: 17.0667vw
      }

      .discount-coupon-info {
        padding: 0 4.2667vw 0 4.5333vw
      }

      .discount-coupon-info {
        border-right: 0.2667vw white dashed
      }

      .discount-coupon-info {
        min-width: 160px
      }

      .discount-coupon-info::before,
      .discount-coupon-info::after,
      .discount-coupon-code::before,
      .discount-coupon-code::after {
        width: 5.8667vw
      }

      .discount-coupon-info::before,
      .discount-coupon-info::after,
      .discount-coupon-code::before,
      .discount-coupon-code::after {
        height: 5.8667vw
      }

      .discount-coupon-info-title {
        font-size: 5.3333vw
      }

      .discount-coupon-info-desc {
        font-size: 3.2vw
      }

      .discount-coupon-code {
        padding: 0 3.2vw
      }

      .discount-coupon-code {
        gap: 2.1333vw
      }

      .discount-coupon-code {
        border-radius: 1.0667vw
      }

      .discount-coupon-code-btn {
        border-radius: 13.3333vw
      }

      .discount-coupon-code-btn {
        border: 0.4vw solid #315800
      }

      .discount-coupon-code-btn {
        padding: 0 4.8vw
      }

      .discount-coupon-code-btn {
        height: 8.5333vw
      }

      .discount-coupon-code-btn span {
        font-size: 3.2vw
      }

      .discount-coupon-code-text {
        font-size: 3.2vw
      }
    }
  </style>

  <script>
    (function() {
      class CopyCoupon extends HTMLElement {
        constructor() {
          super()
          // 如果变体ID为空字符串或未定义，则视为未填写
          const variantIdValue = this.dataset.variantId
          this.variantId = variantIdValue && variantIdValue.trim() !== '' ? variantIdValue : null
          this.content = null
          this.copyBtn = null
          this.discountCode = ''
          this.initialized = false
        }

        connectedCallback() {
          // 避免重复初始化
          if (this.initialized) return

          // 确保 DOM 已经连接后再初始化
          this.content = this.querySelector('.discount-coupon-content')
          this.copyBtn = this.querySelector('[data-copy-coupon-btn]')
          this.discountCode = this.content?.dataset.code || ''

          if (this.content && this.copyBtn) {
            this.initialized = true
            this.init()
          } else {
            console.warn('discount-coupon: Missing required elements', {
              content: !!this.content,
              copyBtn: !!this.copyBtn
            })
          }
        }

        init() {
          // 设置复制按钮
          this.setupCopyButton()
          
          // 如果有变体ID，则监听变体变化；如果没有，则始终显示
          if (this.variantId) {
            this.handleVariantChange()
          } else {
            // 没有变体ID，代表全部变体都显示
            this.classList.add('dl-show')
          }
        }

        handleVariantChange() {
          // 只在有变体ID时才监听变体变化
          if (!this.variantId) return

          // 监听产品表单的变体选择变化
          const productForm = document.querySelector('product-form')
          if (productForm) {
            productForm.addEventListener('variant:change', (e) => {
              this.checkVariant(e.detail?.variant?.id)
            })
          }

          // 监听单选项选择器变化
          document.addEventListener('change', (e) => {
            if (e.target.matches('[data-single-option-selector], [data-product-select]')) {
              setTimeout(() => {
                const variantId = this.getCurrentVariantId()
                this.checkVariant(variantId)
              }, 100)
            }
          })

          // 初始检查
          const currentVariantId = this.getCurrentVariantId()
          this.checkVariant(currentVariantId)
        }

        getCurrentVariantId() {
          const productForm = document.querySelector('product-form')
          if (productForm) {
            const form = productForm.querySelector('form')
            if (form) {
              const variantInput = form.querySelector('input[name="id"]')
              if (variantInput) {
                return variantInput.value
              }
            }
          }

          // 备用方法：从 URL 参数获取
          const urlParams = new URLSearchParams(window.location.search)
          const variantParam = urlParams.get('variant')
          if (variantParam) {
            return variantParam
          }

          return null
        }

        checkVariant(variantId) {
          // 如果没有设置变体ID，始终显示
          if (!this.variantId) {
            this.classList.add('dl-show')
            return
          }

          // 如果有变体ID，检查是否匹配
          if (variantId && String(variantId) === String(this.variantId)) {
            this.classList.add('dl-show')
          } else {
            this.classList.remove('dl-show')
          }
        }

        setupCopyButton() {
          if (!this.copyBtn) {
            console.warn('discount-coupon: Copy button not found')
            return
          }

          this.copyBtn.addEventListener('click', (e) => {
            e.preventDefault()
            e.stopPropagation()
            this.copyToClipboard()
          })
        }

        async copyToClipboard() {
          if (!this.discountCode) {
            console.warn('discount-coupon: No discount code to copy')
            return
          }

          if (!this.copyBtn) {
            console.warn('discount-coupon: Copy button not found')
            return
          }

          try {
            await navigator.clipboard.writeText(this.discountCode)
            this.copyBtn.classList.add('dl-copied')

            // 2秒后恢复按钮状态
            setTimeout(() => {
              this.copyBtn.classList.remove('dl-copied')
            }, 2000)
          } catch (err) {
            // 降级方案：使用传统方法
            const textArea = document.createElement('textarea')
            textArea.value = this.discountCode
            textArea.style.position = 'fixed'
            textArea.style.left = '-999999px'
            document.body.appendChild(textArea)
            textArea.select()

            try {
              document.execCommand('copy')
              this.copyBtn.classList.add('dl-copied')
              setTimeout(() => {
                this.copyBtn.classList.remove('dl-copied')
              }, 2000)
            } catch (e) {
              console.error('Failed to copy:', e)
            } finally {
              document.body.removeChild(textArea)
            }
          }
        }
      }

      // 确保 DOM 准备好后再定义自定义元素
      function defineCopyCoupon() {
        if (!customElements.get('discount-coupon')) {
          customElements.define('discount-coupon', CopyCoupon)
        }
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', defineCopyCoupon)
      } else {
        defineCopyCoupon()
      }
    })()
  </script>
{%- endif -%}

